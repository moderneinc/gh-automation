---
name: publish-containerized-gradle-app

on:
  workflow_call:
    inputs:
      setup_google_cloud_auth:
        description: Whether to attempt setting up google cloud auth. Namely, for pulling artifacts from a Google Registry.
        type: boolean
        default: true
        required: false
      setup_azure_container_registry:
        description: Whether to attempt setting up azure container registry auth.
        type: boolean
        default: true
        required: false
      azure_container_registry_login_server:
        description: Optional container registry URL, assuming setup_azure_container_registry is true.
        type: string
        required: false
      release_scope:
        description: Git tagging release scope, such as major, minor, or patch.
        type: string
        required: true
    secrets:
      google_cloud_service_account_key:
        description: Optional Google Cloud service account key, assuming setup_google_cloud_auth is true.
        required: false
      azure_container_registry_username:
        description: Optional Azure container registry username, assuming setup_azure_container_registry is true.
        required: false
      azure_container_registry_key:
        description: Optional Azure container registry key, assuming setup_azure_container_registry is true.
        required: false
      caller_github_token:
        description: Standard github.token used for git-tagging the release version against the calling repository.
        required: true

env:
  GRADLE_SWITCHES: --console=plain --info --stacktrace 
  GRGIT_AUTH_SWITCHES: "-Dorg.ajoberstar.grgit.auth.username=${{github.actor}} -Dorg.ajoberstar.grgit.auth.password=${{github.caller_github_token}}"
jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - uses: actions/setup-java@v2
        with:
          distribution: temurin
          java-version: 11
          cache: "gradle"

      - name: configure-git-user
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - uses: google-github-actions/auth@v0
        if: inputs.setup_google_cloud_auth
        with:
          credentials_json: ${{ secrets.google_cloud_service_account_key }}

      - uses: google-github-actions/setup-gcloud@v0.5.1

      - name: setup-azure-container-registry
        if: inputs.setup_azure_container_registry
        uses: azure/docker-login@v1
        with:
          login-server: ${{ inputs.azure_container_registry_login_server }}
          username: ${{ secrets.azure_container_registry_username }}
          password: ${{ secrets.azure_container_registry_key }}

      - run: gcloud auth configure-docker
        if: inputs.setup_google_cloud_auth

      - name: Build, tag, and push docker image
        env:
          GCR_KEY: ${{ secrets.google_cloud_service_account_key }}
          TESTCONTAINERS_RYUK_DISABLED: true
        run: ./gradlew ${GRADLE_SWITCHES} ${GRGIT_AUTH_SWITCHES} -Prelease.scope=${{ inputs.release_scope }} final
